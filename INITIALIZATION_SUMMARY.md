# æ•°æ®åº“å’Œå­˜å‚¨åˆå§‹åŒ–æ–¹æ¡ˆæ€»ç»“

## ğŸ¯ è§£å†³çš„é—®é¢˜

Docker éƒ¨ç½²æ—¶çš„åˆå§‹åŒ–æŒ‘æˆ˜ï¼š
1. **PostgreSQL** - ç©ºæ•°æ®åº“ï¼Œç¼ºå°‘è¡¨ç»“æ„
2. **MinIO** - éœ€è¦åˆ›å»ºå­˜å‚¨æ¡¶å’Œé»˜è®¤æ–‡ä»¶
3. **æƒé™ç³»ç»Ÿ** - éœ€è¦åˆå§‹åŒ–æƒé™ã€è§’è‰²å’Œå…³è”

## âœ… é‡‡ç”¨çš„æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¹å™¨å¯åŠ¨æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   1. PostgreSQL å®¹å™¨å¯åŠ¨              â”‚
        â”‚   - å¥åº·æ£€æŸ¥ï¼špg_isready              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   2. MinIO å®¹å™¨å¯åŠ¨                   â”‚
        â”‚   - å¥åº·æ£€æŸ¥ï¼šmc ready                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   3. API å®¹å™¨å¯åŠ¨                     â”‚
        â”‚   â””â”€ docker-entrypoint.sh             â”‚
        â”‚       â”œâ”€ init-db.sh                   â”‚
        â”‚       â”‚   â”œâ”€ ç­‰å¾… PostgreSQL å°±ç»ª      â”‚
        â”‚       â”‚   â””â”€ alembic upgrade head     â”‚
        â”‚       â”‚      (åˆ›å»ºæ‰€æœ‰è¡¨)              â”‚
        â”‚       â””â”€ å¯åŠ¨ FastAPI                 â”‚
        â”‚           â””â”€ lifespan hook            â”‚
        â”‚               â””â”€ init_permissions()   â”‚
        â”‚                   (åˆ›å»ºæƒé™/è§’è‰²)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   4. MinIO è‡ªåŠ¨åˆå§‹åŒ–                 â”‚
        â”‚   - é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºå­˜å‚¨æ¡¶           â”‚
        â”‚   - ensure_bucket_exists()            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ¡ˆ 1: æ•°æ®åº“è¿ç§»ï¼ˆAlembicï¼‰

**å®ç°æ–¹å¼ï¼š** Docker å…¥å£ç‚¹è„šæœ¬

**æ–‡ä»¶ï¼š**
- `docker/init/docker-entrypoint.sh` - å®¹å™¨å…¥å£ç‚¹
- `docker/init/init-db.sh` - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**æµç¨‹ï¼š**
```bash
# 1. ç­‰å¾… PostgreSQL å°±ç»ª
until psql -h postgres -U $POSTGRES_USER -d $POSTGRES_DB -c '\q'; do
  sleep 2
done

# 2. æ‰§è¡Œ Alembic è¿ç§»
alembic upgrade head
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œå®¹å™¨å¯åŠ¨å³åˆå§‹åŒ–
- âœ… å¹‚ç­‰æ€§ï¼Œé‡å¤æ‰§è¡Œä¸ä¼šå‡ºé”™
- âœ… æ”¯æŒç‰ˆæœ¬ç®¡ç†å’Œå¢é‡è¿ç§»
- âœ… æ— éœ€æ‰‹åŠ¨æ“ä½œ

**æ•°æ®åº“è¡¨ï¼š**
- users, accounts (ç”¨æˆ·å’Œç¬¬ä¸‰æ–¹ç™»å½•)
- roles, permissions, user_roles, role_permissions (æƒé™ç³»ç»Ÿ)
- refresh_tokens (åˆ·æ–°ä»¤ç‰Œ)
- files (æ–‡ä»¶è®°å½•)
- threads, thread_turns, turn_files (èŠå¤©å†å²)
- btracks (å¼‚å¸¸è¿½è¸ª)

### æ–¹æ¡ˆ 2: æƒé™ç³»ç»Ÿåˆå§‹åŒ–

**å®ç°æ–¹å¼ï¼š** FastAPI lifespan hook

**æ–‡ä»¶ï¼š** `apps/api/app/main.py`

**æµç¨‹ï¼š**
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    async for db in get_db():
        await init_permissions(db)  # è‡ªåŠ¨åˆå§‹åŒ–
        break
    yield
```

**åˆå§‹åŒ–å†…å®¹ï¼š**
- âœ… 57 ä¸ªæƒé™è®°å½•
- âœ… 4 ä¸ªç³»ç»Ÿè§’è‰²ï¼šadmin, user, guest, operator
- âœ… è§’è‰²-æƒé™å…³è”å…³ç³»
- âœ… å¹‚ç­‰æ€§ï¼šå·²å­˜åœ¨è®°å½•ä¸é‡å¤åˆ›å»º

### æ–¹æ¡ˆ 3: MinIO å­˜å‚¨æ¡¶

**å®ç°æ–¹å¼ï¼š** é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»º

**æ–‡ä»¶ï¼š** `apps/api/app/services/oss.py`

**æµç¨‹ï¼š**
```python
def ensure_bucket_exists(client: Minio, bucket_name: str):
    if not client.bucket_exists(bucket_name):
        client.make_bucket(bucket_name)
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ— éœ€é¢å¤–åˆå§‹åŒ–å®¹å™¨
- âœ… æ‡’åŠ è½½ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»º
- âœ… ä»£ç ç®€æ´ï¼Œç»´æŠ¤æˆæœ¬ä½

**å¯é€‰æ–¹æ¡ˆï¼š** ç‹¬ç«‹åˆå§‹åŒ–å®¹å™¨

å¦‚éœ€é¢„å…ˆä¸Šä¼ é»˜è®¤æ–‡ä»¶ï¼ˆå¦‚é»˜è®¤å¤´åƒï¼‰ï¼Œå¯ä½¿ç”¨ï¼š
- `docker/init/init-minio.py` - MinIO åˆå§‹åŒ–è„šæœ¬
- `docker/init/data/default_avatar.png` - é»˜è®¤å¤´åƒ

### æ–¹æ¡ˆ 4: å¥åº·æ£€æŸ¥

**Docker Compose é…ç½®ï¼š**

```yaml
postgres:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U llmexcel -d llmexcel"]
    interval: 5s
    timeout: 5s
    retries: 5

minio:
  healthcheck:
    test: ["CMD", "mc", "ready", "local"]
    interval: 10s
    timeout: 5s
    retries: 5

api:
  depends_on:
    postgres:
      condition: service_healthy  # ç­‰å¾…æ•°æ®åº“å¥åº·
    minio:
      condition: service_started
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 30s  # ç»™åˆå§‹åŒ– 30 ç§’æ—¶é—´
```

**API å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š**

```python
@app.get("/health")
async def health_check():
    return {"status": "ok"}
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

```
docker/
â”œâ”€â”€ init/
â”‚   â”œâ”€â”€ docker-entrypoint.sh      # API å®¹å™¨å…¥å£ç‚¹ â­
â”‚   â”œâ”€â”€ init-db.sh                # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ â­
â”‚   â”œâ”€â”€ init-minio.py             # MinIO åˆå§‹åŒ–è„šæœ¬ï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ default_avatar.png     # é»˜è®¤å¤´åƒ
â”‚       â””â”€â”€ create_default_avatar.py  # ç”Ÿæˆè„šæœ¬
```

### ä¿®æ”¹æ–‡ä»¶

```
apps/api/
â”œâ”€â”€ Dockerfile                     # æ·»åŠ å…¥å£ç‚¹ã€curlã€psql
â””â”€â”€ app/main.py                    # æ·»åŠ  /health ç«¯ç‚¹

docker/
â”œâ”€â”€ docker-compose.yml             # æ·»åŠ å¥åº·æ£€æŸ¥å’Œä¾èµ–
â””â”€â”€ docker-compose.prod.yml        # åŒä¸Š
```

### æ–‡æ¡£

```
INITIALIZATION.md                  # å®Œæ•´åˆå§‹åŒ–æ–¹æ¡ˆæ–‡æ¡£ â­
INITIALIZATION_SUMMARY.md          # æ–¹æ¡ˆæ€»ç»“ï¼ˆæœ¬æ–‡ä»¶ï¼‰
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### é¦–æ¬¡éƒ¨ç½²

```bash
cd docker

# 1. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
nano .env

# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆè‡ªåŠ¨å®Œæˆæ‰€æœ‰åˆå§‹åŒ–ï¼‰
docker compose up -d

# 3. æŸ¥çœ‹åˆå§‹åŒ–æ—¥å¿—
docker compose logs -f api
```

**é¢„æœŸè¾“å‡ºï¼š**
```
api_1       | ğŸ”§ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬å¯åŠ¨...
api_1       | â³ ç­‰å¾… PostgreSQL å°±ç»ª...
api_1       | âœ… PostgreSQL å·²å°±ç»ª
api_1       | ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»...
api_1       | INFO  [alembic.runtime.migration] Running upgrade -> 648d4ca39b77
api_1       | âœ… æ•°æ®åº“è¿ç§»å®Œæˆ
api_1       | ğŸŒŸ å¯åŠ¨ FastAPI åº”ç”¨...
api_1       | ğŸš€ åˆå§‹åŒ–åº”ç”¨...
api_1       | âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ
```

### éªŒè¯åˆå§‹åŒ–

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
docker compose ps

# æŸ¥çœ‹è§’è‰²æ•°é‡
docker compose exec api /app/.venv/bin/python -c "
from sqlalchemy import create_engine, text
engine = create_engine('postgresql://llmexcel:password@postgres:5432/llmexcel')
with engine.connect() as conn:
    result = conn.execute(text('SELECT COUNT(*) FROM roles'))
    print(f'âœ… è§’è‰²æ•°é‡: {result.scalar()}')
    result = conn.execute(text('SELECT COUNT(*) FROM permissions'))
    print(f'âœ… æƒé™æ•°é‡: {result.scalar()}')
"

# è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹
curl http://localhost:8000/health
# {"status":"ok"}
```

### æ›´æ–°éƒ¨ç½²

```bash
cd docker

# 1. æ‹‰å–æ–°é•œåƒ
docker compose pull

# 2. é‡å¯æœåŠ¡ï¼ˆè‡ªåŠ¨æ‰§è¡Œæ–°çš„è¿ç§»ï¼‰
docker compose up -d

# è¿ç§»ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨æœ¬åœ°å¼€å‘æ¨¡å¼
cd docker
docker compose -f docker-compose.dev.yml up -d  # åªå¯åŠ¨ PostgreSQL + MinIO

# ç„¶åæœ¬åœ°è¿è¡Œ API
cd apps/api
alembic upgrade head  # æ‰‹åŠ¨è¿ç§»
pnpm dev:api          # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```

### 2. ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨é¢„æ„å»ºé•œåƒ
cd docker
cp .env.production.example .env
nano .env  # é…ç½®ç¯å¢ƒå˜é‡

docker compose -f docker-compose.prod.yml up -d
```

### 3. æ•°æ®åº“å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®åº“
docker compose exec postgres pg_dump -U llmexcel llmexcel > backup.sql

# æ¢å¤æ•°æ®åº“
docker compose exec -T postgres psql -U llmexcel llmexcel < backup.sql
```

### 4. è¿ç§»ç®¡ç†

```bash
# åˆ›å»ºæ–°è¿ç§»
cd apps/api
alembic revision --autogenerate -m "æ·»åŠ æ–°è¡¨"

# æŸ¥çœ‹è¿ç§»å†å²
alembic history

# å›æ»šè¿ç§»
alembic downgrade -1
```

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Docker å…¥å£ç‚¹ + Alembic** | å®Œå…¨è‡ªåŠ¨åŒ–ã€ç‰ˆæœ¬ç®¡ç† | éœ€è¦åœ¨é•œåƒä¸­åŒ…å«è„šæœ¬ | â­ æ¨èæ‰€æœ‰åœºæ™¯ |
| **Lifespan Hook** | ä»£ç å†…å®ç°ã€çµæ´» | æ¯æ¬¡å¯åŠ¨éƒ½æ£€æŸ¥ | æƒé™ç³»ç»Ÿåˆå§‹åŒ– |
| **é¦–æ¬¡ä½¿ç”¨åˆ›å»º** | ç®€å•ã€æ‡’åŠ è½½ | æ— æ³•é¢„å…ˆéªŒè¯ | MinIO å­˜å‚¨æ¡¶ |
| **Init å®¹å™¨** | ç‹¬ç«‹è¿è¡Œã€ä¸“ç”¨ | å¢åŠ å¤æ‚åº¦ | éœ€è¦ä¸Šä¼ é»˜è®¤æ–‡ä»¶æ—¶ |

## âœ¨ ç‰¹ç‚¹æ€»ç»“

### è‡ªåŠ¨åŒ–
- âœ… å®¹å™¨å¯åŠ¨å³å®Œæˆæ‰€æœ‰åˆå§‹åŒ–
- âœ… æ— éœ€æ‰‹åŠ¨æ‰§è¡Œä»»ä½•è„šæœ¬
- âœ… å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸€è‡´

### å¯é æ€§
- âœ… å¥åº·æ£€æŸ¥ç¡®ä¿æœåŠ¡å°±ç»ª
- âœ… ä¾èµ–å…³ç³»ç®¡ç†ï¼ˆdepends_on + conditionï¼‰
- âœ… å¹‚ç­‰æ€§ï¼šé‡å¤æ‰§è¡Œå®‰å…¨

### å¯ç»´æŠ¤æ€§
- âœ… Alembic ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬
- âœ… ä»£ç å³æ–‡æ¡£
- âœ… æ”¯æŒå¢é‡è¿ç§»å’Œå›æ»š

### çµæ´»æ€§
- âœ… æ”¯æŒä¸åŒç¯å¢ƒé…ç½®
- âœ… å¯é€‰çš„ MinIO åˆå§‹åŒ–
- âœ… æ˜“äºæ‰©å±•

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [INITIALIZATION.md](INITIALIZATION.md) - å®Œæ•´çš„åˆå§‹åŒ–æ–¹æ¡ˆæ–‡æ¡£
- [docker/README.md](docker/README.md) - Docker éƒ¨ç½²æŒ‡å—
- [VERSION.md](VERSION.md) - ç‰ˆæœ¬ç®¡ç†æŒ‡å—
- [QUICKSTART.md](QUICKSTART.md) - å¿«é€Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“ å¸¸è§é—®é¢˜

### Q: é¦–æ¬¡å¯åŠ¨éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

A: é€šå¸¸ 30-60 ç§’ï¼š
- PostgreSQL å¯åŠ¨ï¼š5-10ç§’
- MinIO å¯åŠ¨ï¼š5-10ç§’
- æ•°æ®åº“è¿ç§»ï¼š10-20ç§’
- åº”ç”¨å¯åŠ¨ï¼š10-20ç§’

### Q: å¦‚ä½•éªŒè¯åˆå§‹åŒ–æ˜¯å¦æˆåŠŸï¼Ÿ

A: æŸ¥çœ‹å®¹å™¨å¥åº·çŠ¶æ€ï¼š
```bash
docker compose ps
# æ‰€æœ‰æœåŠ¡åº”è¯¥æ˜¾ç¤º "healthy"
```

### Q: åˆå§‹åŒ–å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
docker compose logs api
# æŸ¥æ‰¾åŒ…å« "âŒ" çš„é”™è¯¯ä¿¡æ¯
```

### Q: å¯ä»¥è·³è¿‡è¿ç§»å—ï¼Ÿ

A: ä¸å»ºè®®ã€‚ä½†å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä¿®æ”¹å…¥å£ç‚¹è„šæœ¬æ³¨é‡Šæ‰è¿ç§»æ­¥éª¤ã€‚

### Q: MinIO é»˜è®¤æ–‡ä»¶å¦‚ä½•ä¸Šä¼ ï¼Ÿ

A: æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰- é¦–æ¬¡ä½¿ç”¨æ—¶é€šè¿‡ API ä¸Šä¼ 
æ–¹æ¡ˆ B - ä½¿ç”¨ init-minio.py è„šæœ¬é¢„å…ˆä¸Šä¼ 

---

**è®¾è®¡ç†å¿µï¼š** é›¶é…ç½®éƒ¨ç½²ï¼Œå¼€ç®±å³ç”¨ ğŸš€
