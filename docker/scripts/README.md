# å‡çº§è„šæœ¬ä½¿ç”¨æŒ‡å—

æœ¬ç›®å½•åŒ…å«ç”¨äºæ•°æ®åº“è¿ç§»å’Œç‰ˆæœ¬å‡çº§çš„è„šæœ¬ã€‚

## ğŸ“ è„šæœ¬åˆ—è¡¨

| è„šæœ¬ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `upgrade.sh` | å®Œæ•´å‡çº§æµç¨‹ï¼ˆæ¨èï¼‰ | ç‰ˆæœ¬å‡çº§ |
| `migrate.sh` | ä»…æ‰§è¡Œæ•°æ®åº“è¿ç§» | æ‰‹åŠ¨è¿ç§» |
| `backup.sh` | å¤‡ä»½æ•°æ®åº“ | å‡çº§å‰/å®šæœŸå¤‡ä»½ |
| `verify.sh` | éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§ | å‡çº§åéªŒè¯ |
| `rollback.sh` | å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ | å‡çº§å¤±è´¥æ¢å¤ |
| `init-data.sh` | åˆå§‹åŒ–é»˜è®¤æ•°æ® | æ·»åŠ æ–°çš„é»˜è®¤æ•°æ® |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®Œæ•´å‡çº§ï¼ˆæ¨èï¼‰

```bash
cd docker

# å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬
./scripts/upgrade.sh 0.2.0
```

**æµç¨‹è¯´æ˜ï¼š**
```
1. âœ… å¤‡ä»½æ•°æ®åº“ â†’ backups/backup_20250207_120000.sql.gz
2. âœ… æ‹‰å–æ–°é•œåƒ â†’ 0x1461a0/selgetabel-api:0.2.0
3. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
4. âœ… éªŒè¯è¿ç§»ç»“æœ
5. âœ… æ›´æ–° .env é…ç½®
6. âœ… é‡å¯åº”ç”¨
7. âœ… å¥åº·æ£€æŸ¥
```

**å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œä¼šè‡ªåŠ¨å›æ»šã€‚**

### 2. æ‰‹åŠ¨åˆ†æ­¥æ‰§è¡Œ

```bash
cd docker

# 1. å¤‡ä»½æ•°æ®åº“
./scripts/backup.sh

# 2. æ‹‰å–é•œåƒ
export IMAGE_VERSION=0.2.0
docker compose pull

# 3. æ‰§è¡Œè¿ç§»
./scripts/migrate.sh 0.2.0

# 4. éªŒè¯è¿ç§»
./scripts/verify.sh

# 5. æ›´æ–°é…ç½®
nano .env  # ä¿®æ”¹ IMAGE_VERSION=0.2.0

# 6. é‡å¯åº”ç”¨
docker compose up -d api web
```

### 3. å›æ»šå‡çº§

```bash
cd docker

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
./scripts/rollback.sh
```

## ğŸ“‹ è¯¦ç»†è¯´æ˜

### upgrade.sh - å®Œæ•´å‡çº§æµç¨‹

**è¯­æ³•ï¼š**
```bash
./scripts/upgrade.sh <ç‰ˆæœ¬å·>
```

**ç¤ºä¾‹ï¼š**
```bash
./scripts/upgrade.sh 0.2.0
./scripts/upgrade.sh 1.0.0
```

**åŠŸèƒ½ï¼š**
- âœ… è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
- âœ… æ‹‰å–æ–°ç‰ˆæœ¬é•œåƒ
- âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
- âœ… éªŒè¯è¿ç§»ç»“æœ
- âœ… æ›´æ–°é…ç½®æ–‡ä»¶
- âœ… é‡å¯åº”ç”¨
- âœ… å¥åº·æ£€æŸ¥
- âœ… å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
==========================================
å‡†å¤‡å‡çº§åˆ°ç‰ˆæœ¬: 0.2.0
==========================================

æ˜¯å¦ç»§ç»­? (y/n) y

[STEP] æ­¥éª¤ 1/7: å¤‡ä»½æ•°æ®åº“...
[INFO] âœ… å¤‡ä»½å®Œæˆ: ./backups/backup_20250207_120000.sql.gz

[STEP] æ­¥éª¤ 2/7: æ‹‰å–æ–°é•œåƒ...
[INFO] Pulling api... done

[STEP] æ­¥éª¤ 3/7: æ‰§è¡Œæ•°æ®åº“è¿ç§»...
[INFO] âœ… æ•°æ®åº“è¿ç§»å®Œæˆ

[STEP] æ­¥éª¤ 4/7: éªŒè¯è¿ç§»ç»“æœ...
[INFO] âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡

[STEP] æ­¥éª¤ 5/7: æ›´æ–°é…ç½®æ–‡ä»¶...
[INFO]    å·²æ›´æ–° .env: IMAGE_VERSION=0.2.0

[STEP] æ­¥éª¤ 6/7: é‡å¯åº”ç”¨...
[INFO] Recreating api... done

[STEP] æ­¥éª¤ 7/7: å¥åº·æ£€æŸ¥...
==========================================
[INFO] âœ… å‡çº§æˆåŠŸï¼
==========================================
ç‰ˆæœ¬ä¿¡æ¯:
{
  "app": {
    "name": "Selgetabel",
    "version": "0.2.0",
    "build_time": "2025-02-07T12:00:00Z"
  }
}
==========================================
```

---

### backup.sh - æ•°æ®åº“å¤‡ä»½

**è¯­æ³•ï¼š**
```bash
./scripts/backup.sh
```

**åŠŸèƒ½ï¼š**
- å¤‡ä»½ PostgreSQL æ•°æ®åº“
- è‡ªåŠ¨å‹ç¼©ï¼ˆgzipï¼‰
- ä¿ç•™æœ€è¿‘ 10 ä¸ªå¤‡ä»½
- è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½

**å¤‡ä»½ä½ç½®ï¼š**
```
docker/backups/
â”œâ”€â”€ backup_20250207_120000.sql.gz
â”œâ”€â”€ backup_20250206_100000.sql.gz
â””â”€â”€ ...
```

**æ¢å¤å¤‡ä»½ï¼š**
```bash
cd docker

# è§£å‹å¤‡ä»½
gunzip backups/backup_20250207_120000.sql.gz

# æ¢å¤åˆ°æ•°æ®åº“
docker compose exec -T postgres psql \
    -U llmexcel \
    llmexcel \
    < backups/backup_20250207_120000.sql
```

---

### migrate.sh - æ•°æ®åº“è¿ç§»

**è¯­æ³•ï¼š**
```bash
./scripts/migrate.sh <ç‰ˆæœ¬å·>
```

**ç¤ºä¾‹ï¼š**
```bash
./scripts/migrate.sh 0.2.0
```

**åŠŸèƒ½ï¼š**
- è¿è¡Œä¸´æ—¶è¿ç§»å®¹å™¨
- æ‰§è¡Œ `alembic upgrade head`
- ä¸å½±å“è¿è¡Œä¸­çš„åº”ç”¨

**ç­‰ä»·å‘½ä»¤ï¼š**
```bash
docker compose run --rm \
    -e IMAGE_VERSION=0.2.0 \
    init-db
```

---

### verify.sh - éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§

**è¯­æ³•ï¼š**
```bash
./scripts/verify.sh
```

**åŠŸèƒ½ï¼š**
- æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬ï¼ˆAlembic revisionï¼‰
- æ£€æŸ¥ä»£ç è¿ç§»ç‰ˆæœ¬
- æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬
- éªŒè¯ä¸‰è€…æ˜¯å¦ä¸€è‡´

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
[INFO] éªŒè¯æ•°æ®åº“ç‰ˆæœ¬ä¸€è‡´æ€§...
[INFO] æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬...
[INFO]    æ•°æ®åº“ç‰ˆæœ¬: 648d4ca39b77
[INFO] æ£€æŸ¥ä»£ç è¿ç§»ç‰ˆæœ¬...
[INFO]    ä»£ç ç‰ˆæœ¬: 648d4ca39b77
[INFO] æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬...
[INFO]    åº”ç”¨ç‰ˆæœ¬: 0.2.0
==========================================
[INFO] âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡
==========================================
```

---

### rollback.sh - ç‰ˆæœ¬å›æ»š

**è¯­æ³•ï¼š**
```bash
./scripts/rollback.sh
```

**åŠŸèƒ½ï¼š**
- å›æ»šæ•°æ®åº“è¿ç§»ï¼ˆ`alembic downgrade -1`ï¼‰
- æ¢å¤ `.env.bak` é…ç½®
- é‡å¯åº”ç”¨ï¼ˆä½¿ç”¨æ—§ç‰ˆæœ¬ï¼‰
- å¥åº·æ£€æŸ¥

**æ³¨æ„äº‹é¡¹ï¼š**
- âš ï¸ åªèƒ½å›æ»šæœ€è¿‘ä¸€æ¬¡è¿ç§»
- âš ï¸ æ•°æ®å¯èƒ½ä¸¢å¤±ï¼ˆå–å†³äºè¿ç§»å†…å®¹ï¼‰
- âš ï¸ å»ºè®®åœ¨å›æ»šå‰å…ˆå¤‡ä»½

---

### init-data.sh - åˆå§‹åŒ–é»˜è®¤æ•°æ®

**è¯­æ³•ï¼š**
```bash
./scripts/init-data.sh [--db] [--minio] [--all]
```

**ç¤ºä¾‹ï¼š**
```bash
./scripts/init-data.sh --all       # åˆå§‹åŒ–æ‰€æœ‰é»˜è®¤æ•°æ®
./scripts/init-data.sh --db        # åªåˆå§‹åŒ–æ•°æ®åº“æ•°æ®
./scripts/init-data.sh --minio     # åªåˆå§‹åŒ– MinIO æ•°æ®
```

**åŠŸèƒ½ï¼š**
- åˆå§‹åŒ–æ•°æ®åº“é»˜è®¤æ•°æ®ï¼ˆä» `db_data/*.sql`ï¼‰
- åˆå§‹åŒ– MinIO é»˜è®¤æ–‡ä»¶ï¼ˆä» `minio_data/`ï¼‰
- åˆ—å‡ºå¾…åˆå§‹åŒ–çš„æ–‡ä»¶
- ç¡®è®¤åæ‰§è¡Œåˆå§‹åŒ–

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç‰ˆæœ¬å‡çº§åæ·»åŠ äº†æ–°çš„é»˜è®¤æ•°æ®
- éœ€è¦é‡æ–°åˆå§‹åŒ–æŸäº›é»˜è®¤æ•°æ®
- é¦–æ¬¡éƒ¨ç½²åè¡¥å……é»˜è®¤æ•°æ®

**æ³¨æ„äº‹é¡¹ï¼š**
- ç¡®ä¿ SQL æ–‡ä»¶å…·æœ‰å¹‚ç­‰æ€§ï¼ˆä½¿ç”¨ `ON CONFLICT DO NOTHING`ï¼‰
- MinIO æ–‡ä»¶ä¸Šä¼ ä¼šè¦†ç›–åŒåæ–‡ä»¶
- è¿è¡Œå‰å»ºè®®å¤‡ä»½æ•°æ®åº“

---

## ğŸ¯ å¸¸è§åœºæ™¯

### åœºæ™¯ 1ï¼šé¦–æ¬¡éƒ¨ç½²

```bash
cd docker
cp .env.example .env
nano .env  # é…ç½®ç¯å¢ƒå˜é‡

# ä¸€é”®å¯åŠ¨ï¼ˆè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
docker compose up -d
```

### åœºæ™¯ 2ï¼šç‰ˆæœ¬å‡çº§

```bash
cd docker

# æ–¹å¼ Aï¼šä¸€é”®å‡çº§ï¼ˆæ¨èï¼‰
./scripts/upgrade.sh 0.2.0

# æ–¹å¼ Bï¼šæ‰‹åŠ¨åˆ†æ­¥
./scripts/backup.sh
docker compose pull
./scripts/migrate.sh 0.2.0
./scripts/verify.sh
nano .env  # æ›´æ–° IMAGE_VERSION
docker compose up -d
```

### åœºæ™¯ 3ï¼šå‡çº§å¤±è´¥å›æ»š

```bash
# å‡çº§å¤±è´¥æ—¶ä¼šè‡ªåŠ¨å›æ»š
# å¦‚æœéœ€è¦æ‰‹åŠ¨å›æ»šï¼š
cd docker
./scripts/rollback.sh
```

### åœºæ™¯ 4ï¼šå®šæœŸå¤‡ä»½

```bash
cd docker

# æ‰‹åŠ¨å¤‡ä»½
./scripts/backup.sh

# æˆ–è®¾ç½®å®šæ—¶ä»»åŠ¡
crontab -e
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * cd /path/to/docker && ./scripts/backup.sh
```

### åœºæ™¯ 5ï¼šæ£€æŸ¥ç‰ˆæœ¬

```bash
cd docker

# æŸ¥çœ‹è¿è¡Œä¸­çš„ç‰ˆæœ¬
curl http://localhost:8000/version

# æŸ¥çœ‹å“åº”å¤´
curl -I http://localhost:8000/health | grep X-App-Version

# éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§
./scripts/verify.sh
```

### åœºæ™¯ 6ï¼šæ·»åŠ æ–°çš„é»˜è®¤æ•°æ®

```bash
cd docker

# 1. æ·»åŠ æ•°æ®åº“é»˜è®¤æ•°æ®
cat > db_data/04_new_data.sql <<EOF
INSERT INTO settings (key, value)
VALUES ('feature_flag', 'enabled')
ON CONFLICT (key) DO NOTHING;
EOF

# 2. æ·»åŠ  MinIO é»˜è®¤æ–‡ä»¶
cp /path/to/new_logo.png minio_data/

# 3. è¿è¡Œåˆå§‹åŒ–
./scripts/init-data.sh --all

# æˆ–åˆ†åˆ«åˆå§‹åŒ–
./scripts/init-data.sh --db      # åªåˆå§‹åŒ–æ•°æ®åº“
./scripts/init-data.sh --minio   # åªåˆå§‹åŒ– MinIO
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‡çº§å‰æ£€æŸ¥

- âœ… ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆå¤‡ä»½éœ€è¦ï¼‰
- âœ… ç¡®è®¤æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„å…³é”®æ“ä½œ
- âœ… æŸ¥çœ‹ CHANGELOG äº†è§£ç ´åæ€§å˜æ›´

### 2. å‡çº§ä¸­

- âœ… ä¸è¦ä¸­æ–­è„šæœ¬æ‰§è¡Œ
- âœ… ç›‘æ§æ—¥å¿—è¾“å‡º
- âœ… å¦‚æœ‰å¼‚å¸¸ç«‹å³æ£€æŸ¥

### 3. å‡çº§å

- âœ… éªŒè¯æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸
- âœ… æ£€æŸ¥åº”ç”¨æ—¥å¿—
- âœ… ä¿ç•™å¤‡ä»½æ–‡ä»¶

### 4. å›æ»šæ³¨æ„

- âš ï¸ å›æ»šåªèƒ½æ’¤é”€æ•°æ®åº“ schema å˜æ›´
- âš ï¸ æ•°æ®å†…å®¹çš„å˜æ›´å¯èƒ½æ— æ³•å›æ»š
- âš ï¸ è·¨å¤šä¸ªç‰ˆæœ¬å‡çº§åå›æ»šå¯èƒ½å¤æ‚

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå¤‡ä»½å¤±è´¥

**é”™è¯¯ï¼š** `pg_dump: error: connection failed`

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦è¿è¡Œ
docker compose ps postgres

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker compose exec postgres pg_isready

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker compose logs postgres
```

### é—®é¢˜ 2ï¼šè¿ç§»å¤±è´¥

**é”™è¯¯ï¼š** `alembic.util.exc.CommandError`

**è§£å†³ï¼š**
```bash
# æŸ¥çœ‹å½“å‰æ•°æ®åº“ç‰ˆæœ¬
docker compose run --rm init-db alembic current

# æŸ¥çœ‹è¿ç§»å†å²
docker compose run --rm init-db alembic history

# æ‰‹åŠ¨å›æ»š
docker compose run --rm init-db alembic downgrade -1
```

### é—®é¢˜ 3ï¼šåº”ç”¨å¯åŠ¨å¤±è´¥

**é”™è¯¯ï¼š** å¥åº·æ£€æŸ¥è¶…æ—¶

**è§£å†³ï¼š**
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker compose logs api

# æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
./scripts/verify.sh

# æ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/health
```

### é—®é¢˜ 4ï¼šç‰ˆæœ¬ä¸åŒ¹é…

**é”™è¯¯ï¼š** `ç‰ˆæœ¬ä¸åŒ¹é…ï¼`

**è§£å†³ï¼š**
```bash
# è¿è¡Œè¿ç§»
./scripts/migrate.sh <ç‰ˆæœ¬å·>

# æˆ–å›æ»šåˆ°æ—§ç‰ˆæœ¬
./scripts/rollback.sh
```

### é—®é¢˜ 5ï¼šé»˜è®¤æ•°æ®åˆå§‹åŒ–å¤±è´¥

**é”™è¯¯ï¼š** `init-db-data` æˆ– `init-minio` å¤±è´¥

**è§£å†³ï¼š**
```bash
# æŸ¥çœ‹æ—¥å¿—
docker compose logs init-db-data
docker compose logs init-minio

# æ£€æŸ¥æ•°æ®æ–‡ä»¶
ls -la db_data/*.sql
ls -la minio_data/

# é‡æ–°è¿è¡Œåˆå§‹åŒ–
./scripts/init-data.sh --all
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [VERSION.md](../../VERSION.md) - ç‰ˆæœ¬ç®¡ç†è§„èŒƒ
- [DEPLOYMENT_FINAL.md](../../DEPLOYMENT_FINAL.md) - éƒ¨ç½²æ–¹æ¡ˆè¯¦è§£
- [OPTIMIZATION_SUMMARY.md](../../OPTIMIZATION_SUMMARY.md) - ä¼˜åŒ–æ€»ç»“
- [docker/README.md](../README.md) - Docker éƒ¨ç½²æŒ‡å—
- [QUICKSTART.md](../../QUICKSTART.md) - å¿«é€Ÿå¼€å§‹

## ğŸ“‹ è„šæœ¬ä¾èµ–å…³ç³»

```
upgrade.sh (å®Œæ•´å‡çº§æµç¨‹)
â”œâ”€â”€ backup.sh (æ­¥éª¤ 1)
â”œâ”€â”€ migrate.sh (æ­¥éª¤ 3)
â”œâ”€â”€ verify.sh (æ­¥éª¤ 4)
â””â”€â”€ rollback.sh (å¤±è´¥æ—¶)

init-data.sh (ç‹¬ç«‹ä½¿ç”¨)
â”œâ”€â”€ docker compose run init-db-data
â””â”€â”€ docker compose run init-minio
```

---

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„"æ•…éšœæ’æŸ¥"éƒ¨åˆ†
2. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š`docker compose logs -f`
3. æäº¤ Issueï¼šhttps://github.com/your-repo/issues
